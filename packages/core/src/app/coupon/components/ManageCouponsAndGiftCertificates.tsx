import { type Coupon } from '@bigcommerce/checkout-sdk';
import React, { type FunctionComponent, useRef } from 'react';
import { TransitionGroup } from 'react-transition-group';

import { IconCoupon, IconGiftCertificateNew, IconRemoveCoupon, SlideCollapseCSSTransition } from '@bigcommerce/checkout/ui';

import { useMultiCoupon } from '../useMultiCoupon';

interface AnimatedCouponTagProps {
    children: React.ReactNode;
    in?: boolean;
}

const AnimatedCouponTag: FunctionComponent<AnimatedCouponTagProps> = ({ children, in: inProp }) => {
    const nodeRef = useRef<HTMLDivElement>(null);

    return (
        <SlideCollapseCSSTransition
            appear
            classNames="coupon-tag"
            in={inProp}
            nodeRef={nodeRef}
        >
            <div className="coupon-tag-wrapper" ref={nodeRef}>
                {children}
            </div>
        </SlideCollapseCSSTransition>
    );
};

const AppliedCouponsPills: FunctionComponent<{ coupons: Coupon[], removeCoupon: (code: string) => void }> = ({ coupons, removeCoupon }) => {
    return (
        <TransitionGroup component={null}>
            {coupons.map(({ code, displayName }) => (
                <AnimatedCouponTag key={code}>
                    <ul>
                        <IconCoupon />
                        {displayName ? `${displayName} (${code})` : code}
                        <IconRemoveCoupon onClick={() => removeCoupon(code)} />
                    </ul>
                </AnimatedCouponTag>
            ))}
        </TransitionGroup>
    );
};

export const ManageCouponsAndGiftCertificates: FunctionComponent = () => {
    const {
        appliedCoupons,
        appliedGiftCertificates,
        removeCoupon,
        removeGiftCertificate,
    } = useMultiCoupon();

    return (
        <>
            <AppliedCouponsPills
                coupons={appliedCoupons}
                removeCoupon={removeCoupon}
            />
            <TransitionGroup component={null}>
                {appliedGiftCertificates.map(({ code }) => (
                    <AnimatedCouponTag key={code}>
                        <ul>
                            <IconGiftCertificateNew />
                            {code}
                            <IconRemoveCoupon onClick={() => removeGiftCertificate(code)} />
                        </ul>
                    </AnimatedCouponTag>
                ))}
            </TransitionGroup>
        </>
    );
};
