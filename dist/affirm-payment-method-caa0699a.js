"use strict";(self.webpackJsonpCheckout=self.webpackJsonpCheckout||[]).push([[2343],{31698:(e,t,i)=>{i.d(t,{A:()=>m});var n=i(31635),s=i(44218),a=i(69440),r=i(70355),o=i(65685),c=i(94611),d=i(11474),u=i(40646),l=i(91182);const m=e=>{const{description:t,isInitializing:i=!1,initializePayment:m,method:g,onUnhandledError:h=a.noop,deinitializePayment:p}=e,[f,y]=(0,r.useState)(!1),[b,I]=(0,r.useState)(),v=function(e){const t=(0,s.B4)(((e=[])=>e.filter(o.A))),i=(0,s.B4)(((e=[])=>e.filter((({trustedShippingAddress:e})=>e)))),{checkoutService:n,checkoutState:a,isUsingMultiShipping:r=!1,method:d}=e,{data:{getCart:u,getConfig:l,getCustomer:m,getInstruments:g,isPaymentDataRequired:h,isPaymentDataSubmitted:p},statuses:{isLoadingInstruments:f}}=a,y=u(),b=l(),I=m();if(!b||!y||!I)throw new Error("Unable to get checkout");const v=t(g(d)),_=i(v);return{instruments:_,isNewAddress:0===_.length&&v.length>0,isInstrumentFeatureAvailable:!p(d.id,d.gateway)&&(0,c.A)({config:b,customer:I,isUsingMultiShipping:r,paymentMethod:d}),isLoadingInstruments:f(),isPaymentDataRequired:h(),loadInstruments:n.loadInstruments}}(e),{isLoadingInstruments:_,instruments:M,isNewAddress:k,isInstrumentFeatureAvailable:C,loadInstruments:P}=v,S=(0,r.useCallback)((()=>{if(!f&&M.length)return(0,a.find)(M,{defaultInstrument:!0})||M[0]}),[f,M]),w=(0,r.useCallback)((()=>{y(!0),I(void 0)}),[]),A=(0,r.useCallback)((e=>{y(!1),I((0,a.find)(M,{bigpayToken:e}))}),[M]);(0,r.useEffect)((()=>((0,n.__awaiter)(void 0,void 0,void 0,(function*(){try{yield m({gatewayId:g.gateway,methodId:g.id}),C&&(yield P())}catch(e){h(e)}})),()=>{(0,n.__awaiter)(void 0,void 0,void 0,(function*(){try{yield p({gatewayId:g.gateway,methodId:g.id})}catch(e){h(e)}}))})),[]);const z=b||S(),N=i||_,E=C&&(M.length>0||k);return t||C?r.createElement(l.A,{hideContentWhenLoading:!0,isLoading:N},r.createElement("div",{className:"paymentMethod paymentMethod--hosted"},t,E&&r.createElement(d.A,{instruments:M,onSelectInstrument:A,onUseNewInstrument:w,selectedInstrument:z}),C&&r.createElement(u.A,{instrumentId:z&&z.bigpayToken,instruments:M,isAccountInstrument:!0}))):null}},54022:(e,t,i)=>{i.d(t,{AffirmPaymentMethod:()=>A});var n,s,a=i(31635);class r extends Error{constructor(e){var t;super(e||"An unexpected error has occurred."),this.name="StandardError",this.type="standard",t=new.target.prototype,Object.setPrototypeOf?Object.setPrototypeOf(this,t):this.__proto__=t,"function"==typeof Error.captureStackTrace?Error.captureStackTrace(this,new.target):this.stack=new Error(this.message).stack}}!function(e){e[e.MissingBillingAddress=0]="MissingBillingAddress",e[e.MissingCart=1]="MissingCart",e[e.MissingCheckout=2]="MissingCheckout",e[e.MissingConsignments=3]="MissingConsignments",e[e.MissingCustomer=4]="MissingCustomer",e[e.MissingCheckoutConfig=5]="MissingCheckoutConfig",e[e.MissingOrder=6]="MissingOrder",e[e.MissingOrderConfig=7]="MissingOrderConfig",e[e.MissingOrderId=8]="MissingOrderId",e[e.MissingPayment=9]="MissingPayment",e[e.MissingPaymentId=10]="MissingPaymentId",e[e.MissingPaymentInstrument=11]="MissingPaymentInstrument",e[e.MissingPaymentMethod=12]="MissingPaymentMethod",e[e.MissingPaymentRedirectUrl=13]="MissingPaymentRedirectUrl",e[e.MissingPaymentStatus=14]="MissingPaymentStatus",e[e.MissingPaymentToken=15]="MissingPaymentToken",e[e.MissingShippingAddress=16]="MissingShippingAddress"}(n||(n={}));class o extends r{constructor(e){super(function(e){switch(e){case n.MissingBillingAddress:return"Unable to proceed because billing address data is unavailable.";case n.MissingCart:return"Unable to proceed because cart data is unavailable.";case n.MissingConsignments:return"Unable to proceed because consignments data is unavailable.";case n.MissingCheckout:return"Unable to proceed because checkout data is unavailable.";case n.MissingCustomer:return"Unable to proceed because customer data is unavailable.";case n.MissingCheckoutConfig:case n.MissingOrderConfig:return"Unable to proceed because configuration data is unavailable.";case n.MissingOrder:return"Unable to proceed because order data is unavailable.";case n.MissingOrderId:return"Unable to proceed because order ID is unavailable or not generated yet.";case n.MissingPayment:return"Unable to proceed because payment data is unavailable.";case n.MissingPaymentToken:return"Unable to proceed because the token required to submit a payment is missing.";case n.MissingPaymentMethod:return"Unable to proceed because payment method data is unavailable or not properly configured.";case n.MissingShippingAddress:return"Unable to proceed because shipping address data is unavailable.";default:return"Unable to proceed because the required data is unavailable."}}(e)),this.subtype=e,this.name="MissingDataError",this.type="missing_data"}}!function(e){e[e.CheckoutButtonNotInitialized=0]="CheckoutButtonNotInitialized",e[e.CustomerNotInitialized=1]="CustomerNotInitialized",e[e.PaymentNotInitialized=2]="PaymentNotInitialized",e[e.ShippingNotInitialized=3]="ShippingNotInitialized",e[e.SpamProtectionNotInitialized=4]="SpamProtectionNotInitialized"}(s||(s={}));class c extends r{constructor(e){super(function(e){switch(e){case s.CustomerNotInitialized:return"Unable to proceed because the customer step of checkout has not been initialized.";case s.PaymentNotInitialized:return"Unable to proceed because the payment step of checkout has not been initialized.";case s.ShippingNotInitialized:return"Unable to proceed because the shipping step of checkout has not been initialized.";case s.SpamProtectionNotInitialized:return"Unable to proceed because the checkout spam protection has not been initialized.";default:return"Unable to proceed because the required component has not been initialized."}}(e)),this.subtype=e,this.name="NotInitializedError",this.type="not_initialized"}}class d extends r{constructor(e){super(e||"Invalid arguments have been provided."),this.name="InvalidArgumentError",this.type="invalid_argument"}}class u extends d{constructor(e){let t="Unable to submit payment for the order because the payload is invalid.";e&&(t=`${t} Make sure the following fields are provided correctly: ${e.join(", ")}.`),super(t),this.name="PaymentArgumentInvalidError"}}class l extends r{constructor(){super("The current order does not need to be finalized at this stage."),this.name="OrderFinalizationNotRequiredError",this.type="order_finalization_not_required"}}class m extends r{constructor(e){super(e||"Payment process was cancelled."),this.name="PaymentMethodCancelledError",this.type="payment_cancelled"}}const g={body:{},headers:{},status:0};class h extends r{constructor(e,{message:t,errors:i}={}){const{body:n,headers:s,status:a}=e||g;super(t||"An unexpected error has occurred."),this.name="RequestError",this.type="request",this.body=n,this.headers=s,this.status=a,this.errors=i||[]}}class p extends h{constructor(e){super(e,{message:"There is a problem processing your payment. Please try again later."}),this.name="PaymentMethodInvalidError",this.type="payment_method_invalid"}}class f{constructor(e){this._decimalPlaces=e}toInteger(e){return Math.round(e*Math.pow(10,this._decimalPlaces))}}var y,b=function(e,t,i,n){return new(i||(i=Promise))((function(s,a){function r(e){try{c(n.next(e))}catch(e){a(e)}}function o(e){try{c(n.throw(e))}catch(e){a(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(r,o)}c((n=n.apply(e,t||[])).next())}))};class I{constructor(e,t){this.paymentIntegrationService=e,this.affirmScriptLoader=t}initialize(e){return b(this,void 0,void 0,(function*(){yield this.paymentIntegrationService.loadPaymentMethod(e.methodId);const t=this.paymentIntegrationService.getState(),{clientToken:i,config:{testMode:s}}=t.getPaymentMethodOrThrow(e.methodId);if(!i)throw new o(n.MissingPaymentMethod);this.affirm=yield this.affirmScriptLoader.load(i,s)}))}execute(e,t){var i;return b(this,void 0,void 0,(function*(){const n=null===(i=e.payment)||void 0===i?void 0:i.methodId,{useStoreCredit:a}=e;if(!this.affirm)throw new c(s.PaymentNotInitialized);if(!n)throw new u(["payment.methodId"]);yield this.paymentIntegrationService.submitOrder({useStoreCredit:a},t);const r={methodId:n,paymentData:{nonce:(yield this.initializeAffirmCheckout()).checkout_token}};yield this.paymentIntegrationService.submitPayment(r)}))}deinitialize(){return this.affirm&&(this.affirm=void 0),Promise.resolve()}finalize(){return Promise.reject(new l)}initializeAffirmCheckout(){var e;return null===(e=this.affirm)||void 0===e||e.checkout(this.getCheckoutInformation()),new Promise(((e,t)=>{var i,n;null===(i=this.affirm)||void 0===i||i.checkout.open({onFail:e=>{"canceled"===e.reason?t(new m):t(new p)},onSuccess:t=>{e(t)}}),null===(n=this.affirm)||void 0===n||n.ui.error.on("close",(()=>{t(new m)}))}))}getCheckoutInformation(){const e=this.paymentIntegrationService.getState(),t=e.getStoreConfig(),i=e.getConsignments(),s=e.getOrder(),a=e.getCart();if(!t)throw new o(n.MissingCheckoutConfig);if(!s)throw new o(n.MissingCheckout);const r=new f(s.currency.decimalPlaces),c=this.getBillingAddress(),d=this.getShippingAddress(),u=((e,t)=>!!e&&(!!e.lineItems.physicalItems.some((e=>e.isShippingRequired))||!(!t||!e.lineItems.customItems)&&e.lineItems.customItems.length>0))(a,t)&&d?d:c;return{merchant:{user_confirmation_url:t.links.checkoutLink,user_cancel_url:t.links.checkoutLink,user_confirmation_url_action:"POST"},shipping:u,billing:c,items:this.getItems(r,s),metadata:{shipping_type:this.getShippingType(i),mode:"modal",platform_type:"BigCommerce",platform_version:"",platform_affirm:""},discounts:this.getDiscounts(r,s),order_id:s.orderId?s.orderId.toString():"",shipping_amount:r.toInteger(s.shippingCostTotal),tax_amount:r.toInteger(s.taxTotal),total:r.toInteger(s.orderAmount)}}getShippingType(e){if(!e)return"";const t=e[0];return(null==t?void 0:t.selectedShippingOption)?t.selectedShippingOption.type:""}getBillingAddress(){const e=this.paymentIntegrationService.getState().getBillingAddress();if(!e)throw new o(n.MissingBillingAddress);return{name:{first:e.firstName,last:e.lastName,full:`${e.firstName} ${e.lastName}`},address:{line1:e.address1,line2:e.address2,city:e.city,state:e.stateOrProvinceCode,zipcode:e.postalCode,country:e.countryCode},phone_number:e.phone,email:e.email}}getShippingAddress(){const e=this.paymentIntegrationService.getState().getShippingAddress();if(e)return{name:{first:e.firstName,last:e.lastName,full:`${e.firstName} ${e.lastName}`},address:{line1:e.address1,line2:e.address2,city:e.city,state:e.stateOrProvinceCode,zipcode:e.postalCode,country:e.countryCode},phone_number:e.phone}}getItems(e,t){const i=[];return t.lineItems.physicalItems.forEach((t=>{i.push({display_name:t.name,sku:t.sku,unit_price:e.toInteger(t.salePrice),qty:t.quantity,item_image_url:t.imageUrl,item_url:t.url,categories:this.getCategories(t.categories)})})),t.lineItems.digitalItems.forEach((t=>{i.push({display_name:t.name,sku:t.sku,unit_price:e.toInteger(t.salePrice),qty:t.quantity,item_image_url:t.imageUrl,item_url:t.url,categories:this.getCategories(t.categories)})})),t.lineItems.giftCertificates.forEach((t=>{i.push({display_name:t.name,sku:"",unit_price:e.toInteger(t.amount),qty:1,item_image_url:"",item_url:""})})),t.lineItems.customItems&&t.lineItems.customItems.forEach((t=>{i.push({display_name:t.name,sku:t.sku,unit_price:e.toInteger(t.listPrice),qty:t.quantity,item_image_url:"",item_url:""})})),i}getDiscounts(e,t){const i={};return t.coupons.forEach((t=>{t.discountedAmount>0&&(i[t.code]={discount_amount:e.toInteger(t.discountedAmount),discount_display_name:t.displayName})})),t.discountAmount>0&&(i.DISCOUNTED_AMOUNT={discount_amount:e.toInteger(t.discountAmount),discount_display_name:"discount"}),i}getCategories(e){return e?e.map((e=>e.map((e=>e.name)))):[[]]}}class v extends r{constructor(e){super(e||"Unable to proceed because the client library of a payment method is not loaded or ready to be used."),this.name="PaymentMethodClientUnavailableError",this.type="payment_method_client_unavailable"}}!function(e){e.PROD="//cdn1.affirm.com/js/v2/affirm.js",e.SANDBOX="//cdn1-sandbox.affirm.com/js/v2/affirm.js"}(y||(y={}));class _{constructor(e=window){this.affirmWindow=e}load(e="",t){const i=t?y.SANDBOX:y.PROD;if(function(e,t,i,n,s,a,r){const o=e[i]||{},c=document.createElement(a),d=document.getElementsByTagName(a)[0],u=function(e,t,i){return function(){e[t]._.push([i,arguments])}};o[n]=u(o,n,"set");const l=o[n];o[s]={},o[s]._=[],l._=[],o._=[],o[s][r]=u(o,s,r),o.jsReady=function(){o._.push([r,arguments])};let m=0;for(const e="set add save post open empty reset on off trigger ready setProduct".split(" ");m<e.length;m++)l[e[m]]=u(o,n,e[m]);let g=0;for(const e=["get","token","url","items"];g<e.length;g++)l[e[g]]=function(){};c.async=!0,c.src=t[a],d.parentNode&&d.parentNode.insertBefore(c,d),delete t[a],l(t),e[i]=o}(window,{public_api_key:e,script:i},"affirm","checkout","ui","script","ready"),!this.affirmWindow.affirm)throw new v;return Promise.resolve(this.affirmWindow.affirm)}}const M=(k=e=>new I(e,new _),C=[{id:"affirm"}],Object.assign(k,{resolveIds:C}));var k,C,P=i(70355),S=i(31698),w=i(49655);const A=(0,i(19285).A)((e=>{var{checkoutService:t}=e,i=(0,a.__rest)(e,["checkoutService"]);const n=(0,P.useMemo)((()=>P.createElement(w.A,{id:"payment.affirm_body_text"})),[]),s=(0,P.useCallback)((e=>t.initializePayment(Object.assign(Object.assign({},e),{integrations:[M]}))),[t]);return P.createElement(S.A,Object.assign({},i,{checkoutService:t,deinitializePayment:t.deinitializePayment,description:n,initializePayment:s}))}),[{id:"affirm"}])},94611:(e,t,i)=>{function n({config:e,customer:t,isUsingMultiShipping:i,paymentMethod:n}){return!(!e.checkoutSettings.isCardVaultingEnabled||!n.config.isVaultingEnabled||t.isGuest||i)}i.d(t,{A:()=>n})}}]);
//# sourceMappingURL=affirm-payment-method-caa0699a.js.map