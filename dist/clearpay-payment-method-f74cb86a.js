"use strict";(self.webpackJsonpCheckout=self.webpackJsonpCheckout||[]).push([[1585],{31698:(e,t,i)=>{i.d(t,{A:()=>h});var n=i(31635),a=i(44218),s=i(69440),r=i(70355),o=i(65685),c=i(94611),d=i(11474),u=i(40646),l=i(91182);const h=e=>{const{description:t,isInitializing:i=!1,initializePayment:h,method:p,onUnhandledError:m=s.noop,deinitializePayment:g}=e,[y,b]=(0,r.useState)(!1),[v,f]=(0,r.useState)(),I=function(e){const t=(0,a.B4)(((e=[])=>e.filter(o.A))),i=(0,a.B4)(((e=[])=>e.filter((({trustedShippingAddress:e})=>e)))),{checkoutService:n,checkoutState:s,isUsingMultiShipping:r=!1,method:d}=e,{data:{getCart:u,getConfig:l,getCustomer:h,getInstruments:p,isPaymentDataRequired:m,isPaymentDataSubmitted:g},statuses:{isLoadingInstruments:y}}=s,b=u(),v=l(),f=h();if(!v||!b||!f)throw new Error("Unable to get checkout");const I=t(p(d)),M=i(I);return{instruments:M,isNewAddress:0===M.length&&I.length>0,isInstrumentFeatureAvailable:!g(d.id,d.gateway)&&(0,c.A)({config:v,customer:f,isUsingMultiShipping:r,paymentMethod:d}),isLoadingInstruments:y(),isPaymentDataRequired:m(),loadInstruments:n.loadInstruments}}(e),{isLoadingInstruments:M,instruments:w,isNewAddress:S,isInstrumentFeatureAvailable:k,loadInstruments:C}=I,P=(0,r.useCallback)((()=>{if(!y&&w.length)return(0,s.find)(w,{defaultInstrument:!0})||w[0]}),[y,w]),_=(0,r.useCallback)((()=>{b(!0),f(void 0)}),[]),z=(0,r.useCallback)((e=>{b(!1),f((0,s.find)(w,{bigpayToken:e}))}),[w]);(0,r.useEffect)((()=>((0,n.__awaiter)(void 0,void 0,void 0,(function*(){try{yield h({gatewayId:p.gateway,methodId:p.id}),k&&(yield C())}catch(e){m(e)}})),()=>{(0,n.__awaiter)(void 0,void 0,void 0,(function*(){try{yield g({gatewayId:p.gateway,methodId:p.id})}catch(e){m(e)}}))})),[]);const U=v||P(),A=i||M,O=k&&(w.length>0||S);return t||k?r.createElement(l.A,{hideContentWhenLoading:!0,isLoading:A},r.createElement("div",{className:"paymentMethod paymentMethod--hosted"},t,O&&r.createElement(d.A,{instruments:w,onSelectInstrument:z,onUseNewInstrument:_,selectedInstrument:U}),k&&r.createElement(u.A,{instrumentId:U&&U.bigpayToken,instruments:w,isAccountInstrument:!0}))):null}},90221:(e,t,i)=>{i.d(t,{ClearpayPaymentMethod:()=>P});var n,a,s,r=i(31635),o=i(80315),c=i(69440);class d extends Error{constructor(e){var t;super(e||"An unexpected error has occurred."),this.name="StandardError",this.type="standard",t=new.target.prototype,Object.setPrototypeOf?Object.setPrototypeOf(this,t):this.__proto__=t,"function"==typeof Error.captureStackTrace?Error.captureStackTrace(this,new.target):this.stack=new Error(this.message).stack}}class u extends d{constructor(e){super(e||"Invalid arguments have been provided."),this.name="InvalidArgumentError",this.type="invalid_argument"}}class l extends u{constructor(e){let t="Unable to submit payment for the order because the payload is invalid.";e&&(t=`${t} Make sure the following fields are provided correctly: ${e.join(", ")}.`),super(t),this.name="PaymentArgumentInvalidError"}}(a=n||(n={}))[a.MissingBillingAddress=0]="MissingBillingAddress",a[a.MissingCart=1]="MissingCart",a[a.MissingCheckout=2]="MissingCheckout",a[a.MissingConsignments=3]="MissingConsignments",a[a.MissingCustomer=4]="MissingCustomer",a[a.MissingCheckoutConfig=5]="MissingCheckoutConfig",a[a.MissingOrder=6]="MissingOrder",a[a.MissingOrderConfig=7]="MissingOrderConfig",a[a.MissingOrderId=8]="MissingOrderId",a[a.MissingPayment=9]="MissingPayment",a[a.MissingPaymentId=10]="MissingPaymentId",a[a.MissingPaymentInstrument=11]="MissingPaymentInstrument",a[a.MissingPaymentMethod=12]="MissingPaymentMethod",a[a.MissingPaymentRedirectUrl=13]="MissingPaymentRedirectUrl",a[a.MissingPaymentStatus=14]="MissingPaymentStatus",a[a.MissingPaymentToken=15]="MissingPaymentToken",a[a.MissingShippingAddress=16]="MissingShippingAddress";class h extends d{constructor(e){super(function(e){switch(e){case n.MissingBillingAddress:return"Unable to proceed because billing address data is unavailable.";case n.MissingCart:return"Unable to proceed because cart data is unavailable.";case n.MissingConsignments:return"Unable to proceed because consignments data is unavailable.";case n.MissingCheckout:return"Unable to proceed because checkout data is unavailable.";case n.MissingCustomer:return"Unable to proceed because customer data is unavailable.";case n.MissingCheckoutConfig:case n.MissingOrderConfig:return"Unable to proceed because configuration data is unavailable.";case n.MissingOrder:return"Unable to proceed because order data is unavailable.";case n.MissingOrderId:return"Unable to proceed because order ID is unavailable or not generated yet.";case n.MissingPayment:return"Unable to proceed because payment data is unavailable.";case n.MissingPaymentToken:return"Unable to proceed because the token required to submit a payment is missing.";case n.MissingPaymentMethod:return"Unable to proceed because payment method data is unavailable or not properly configured.";case n.MissingShippingAddress:return"Unable to proceed because shipping address data is unavailable.";default:return"Unable to proceed because the required data is unavailable."}}(e)),this.subtype=e,this.name="MissingDataError",this.type="missing_data"}}class p extends d{constructor(e){super(e||"The current order could not be finalized successfully"),this.name="OrderFinalizationNotCompletedError",this.type="order_finalization_not_completed"}}!function(e){e[e.CheckoutButtonNotInitialized=0]="CheckoutButtonNotInitialized",e[e.CustomerNotInitialized=1]="CustomerNotInitialized",e[e.PaymentNotInitialized=2]="PaymentNotInitialized",e[e.ShippingNotInitialized=3]="ShippingNotInitialized",e[e.SpamProtectionNotInitialized=4]="SpamProtectionNotInitialized"}(s||(s={}));class m extends d{constructor(e){super(function(e){switch(e){case s.CustomerNotInitialized:return"Unable to proceed because the customer step of checkout has not been initialized.";case s.PaymentNotInitialized:return"Unable to proceed because the payment step of checkout has not been initialized.";case s.ShippingNotInitialized:return"Unable to proceed because the shipping step of checkout has not been initialized.";case s.SpamProtectionNotInitialized:return"Unable to proceed because the checkout spam protection has not been initialized.";default:return"Unable to proceed because the required component has not been initialized."}}(e)),this.subtype=e,this.name="NotInitializedError",this.type="not_initialized"}}const g={body:{},headers:{},status:0};class y extends d{constructor(e,{message:t,errors:i}={}){const{body:n,headers:a,status:s}=e||g;super(t||"An unexpected error has occurred."),this.name="RequestError",this.type="request",this.body=n,this.headers=a,this.status=s,this.errors=i||[]}}var b=function(e,t,i,n){return new(i||(i=Promise))((function(a,s){function r(e){try{c(n.next(e))}catch(e){s(e)}}function o(e){try{c(n.throw(e))}catch(e){s(e)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(r,o)}c((n=n.apply(e,t||[])).next())}))};class v{constructor(e,t){this._paymentIntegrationService=e,this._clearpayScriptLoader=t}initialize(e){return b(this,void 0,void 0,(function*(){const{getPaymentMethodOrThrow:t}=this._paymentIntegrationService.getState(),i=t(e.methodId,e.gatewayId);this._clearpaySdk=yield this._clearpayScriptLoader.load(i)}))}deinitialize(){return this._clearpaySdk=void 0,Promise.resolve()}execute(e,t){return b(this,void 0,void 0,(function*(){const{gatewayId:i,methodId:n}=e.payment||{};if(!i||!n)throw new l(["payment.gatewayId","payment.methodId"]);const a=this._paymentIntegrationService.getState(),{isStoreCreditApplied:s}=a.getCheckoutOrThrow();yield this._paymentIntegrationService.applyStoreCredit(s),yield this._paymentIntegrationService.validateCheckout(a.getCheckout(),t);const{countryCode:r}=a.getBillingAddressOrThrow();if(!this._isCountrySupported(r))throw new u("Unable to proceed because billing country is not supported.");return yield this._loadPaymentMethod(i,n,t),yield this._redirectToClearpay(r,this._paymentIntegrationService.getState().getPaymentMethod(n,i)),new Promise(c.noop)}))}finalize(e){var t,i,a;return b(this,void 0,void 0,(function*(){const s=this._paymentIntegrationService.getState(),r=s.getPaymentId(),o=s.getContextConfig();if(!r)throw new h(n.MissingCheckout);if(!o||!o.payment.token)throw new h(n.MissingCheckoutConfig);const c={methodId:r.providerId,paymentData:{nonce:o.payment.token}};yield this._paymentIntegrationService.submitOrder({},e);try{yield this._paymentIntegrationService.submitPayment(c)}catch(e){if(yield this._paymentIntegrationService.forgetCheckout(r.providerId),yield this._paymentIntegrationService.loadPaymentMethods(),(e=>"object"==typeof e&&null!==e&&"body"in e)(e))throw new p(null===(a=null===(i=null===(t=e.body)||void 0===t?void 0:t.errors)||void 0===i?void 0:i[0])||void 0===a?void 0:a.message)}}))}_redirectToClearpay(e,t){return b(this,void 0,void 0,(function*(){if(!this._clearpaySdk||!t||!t.clientToken)throw new m(s.PaymentNotInitialized);return this._clearpaySdk.initialize({countryCode:e}),this._clearpaySdk.redirect({token:t.clientToken}),Promise.resolve()}))}_isCountrySupported(e){return"GB"===e}_loadPaymentMethod(e,t,i){var n;return b(this,void 0,void 0,(function*(){try{return yield this._paymentIntegrationService.loadPaymentMethod(e,Object.assign(Object.assign({},i),{params:Object.assign(Object.assign({},null==i?void 0:i.params),{method:t})}))}catch(e){if(e instanceof y&&422===(null===(n=e.body)||void 0===n?void 0:n.status))throw new u("Clearpay can't process your payment for this order, please try another payment method");throw e}}))}}class f extends d{constructor(e){super(e||"Unable to proceed because the client library of a payment method is not loaded or ready to be used."),this.name="PaymentMethodClientUnavailableError",this.type="payment_method_client_unavailable"}}class I{constructor(e,t=window){this._scriptLoader=e,this._window=t}load(e){return t=this,n=function*(){if(yield this._scriptLoader.loadScript(this._getScriptUrl(e.config.testMode)),!this._window.AfterPay)throw new f;return this._window.AfterPay},new((i=void 0)||(i=Promise))((function(e,a){function s(e){try{o(n.next(e))}catch(e){a(e)}}function r(e){try{o(n.throw(e))}catch(e){a(e)}}function o(t){var n;t.done?e(t.value):(n=t.value,n instanceof i?n:new i((function(e){e(n)}))).then(s,r)}o((n=n.apply(t,[])).next())}));var t,i,n}_getScriptUrl(e){return e?"//portal.sandbox.clearpay.co.uk/afterpay-async.js":"//portal.clearpay.co.uk/afterpay-async.js"}}const M=(w=e=>new v(e,new I((0,o.vQ)())),S=[{gateway:"clearpay"},{id:"clearpay"}],Object.assign(w,{resolveIds:S}));var w,S,k=i(70355),C=i(31698);const P=(0,i(19285).A)((e=>{var{checkoutService:t,checkoutState:i,method:n,paymentForm:a}=e,s=(0,r.__rest)(e,["checkoutService","checkoutState","method","paymentForm"]);const o=(0,k.useCallback)((e=>t.initializePayment(Object.assign(Object.assign({},e),{integrations:[M]}))),[t]);return k.createElement(C.A,Object.assign({},s,{checkoutService:t,checkoutState:i,deinitializePayment:t.deinitializePayment,initializePayment:o,method:n,paymentForm:a}))}),[{gateway:"clearpay"}])},94611:(e,t,i)=>{function n({config:e,customer:t,isUsingMultiShipping:i,paymentMethod:n}){return!(!e.checkoutSettings.isCardVaultingEnabled||!n.config.isVaultingEnabled||t.isGuest||i)}i.d(t,{A:()=>n})}}]);
//# sourceMappingURL=clearpay-payment-method-f74cb86a.js.map